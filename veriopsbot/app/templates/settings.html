{% extends "layout.html" %}

{% block title %}Tenant Settings · VeriOps{% endblock %}

{% block header %}{% endblock %}

{% block header_actions %}
<span class="text-white-50 small me-3">{{ user_email }}</span>
<a href="/documents" class="btn btn-outline-light btn-sm">Documents</a>
<a href="/logout" class="btn btn-outline-light btn-sm">Log out</a>
{% endblock %}

{% block content %}
<div class="portal-hero mb-4">
    <div class="row align-items-center g-4">
        <div class="col-lg-12">
            <span class="portal-pill"><i class="bi bi-sliders2-vertical me-1"></i>Settings</span>
            <p>Tune your assistant stack.
                Manage providers, CRM credentials, and omnichannel access for your workspace.</p>
        </div>
    </div>
</div>

{% if message %}
<div class="alert alert-success alert-dismissible fade show d-flex align-items-center gap-2" role="alert">
    <svg class="flex-shrink-0" width="20" height="20" aria-hidden="true">
        <use xlink:href="#portal-info-icon"></use>
    </svg>
    <div>{{ message }}</div>
    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% if errors %}
<div class="alert alert-danger">
    <ul class="mb-0">
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="portal-stats-grid mb-4">
    <div class="portal-stat-card">
        <span class="portal-stat-label">LLM provider</span>
        <span class="portal-stat-value">{{ form_values.llm_name or "Not set" }}</span>
        <span class="portal-stat-hint">Model: {{ form_values.llm_model_answer or "—" }}</span>
    </div>
    <div class="portal-stat-card">
        <span class="portal-stat-label">Embedding model</span>
        <span class="portal-stat-value">{{ form_values.llm_openai_embed_model or "—"
            }}</span>
        <span class="portal-stat-hint">Used for RAG ingestion.</span>
    </div>
    <div class="portal-stat-card">
        <span class="portal-stat-label">CRM endpoint</span>
        <span class="portal-stat-value">{{ form_values.crm_url or "Not configured"
            }}</span>
        <span class="portal-stat-hint">Token ending with {{ (form_values.crm_token or "")[-4:] }}</span>
    </div>
    <div class="portal-stat-card">
        <span class="portal-stat-label">Chatwoot</span>
        <span class="portal-stat-value">{{ form_values.chatwoot_api_url or "—"
            }}</span>
        <span class="portal-stat-hint">Account ID {{ form_values.chatwoot_account_id or "?" }}</span>
    </div>
</div>

<form method="post" action="/settings" class="settings-form" data-loading-modal="true">
    <div class="portal-card portal-card--glass settings-summary-card">
        <header class="settings-form-header">
            <div>
                <p class="text-uppercase small fw-semibold text-muted mb-1">Workspace controls</p>
                <h3 class="mb-1">Configure your assistant stack</h3>
                <p class="mb-0 text-muted">Update each section in order: LLM provider, CRM bridge, and Omnichannel.</p>
            </div>
            <p class="small mb-0 text-muted">Last saved {{ last_saved_at or "just now" }}</p>
        </header>
    </div>

    <div class="accordion settings-accordion" id="settingsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-llm">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-llm" aria-expanded="false" aria-controls="collapse-llm">
                    <div>
                        <p class="text-uppercase small fw-semibold text-muted mb-1">LLM provider</p>
                        <span class="text-muted small">Language + retrieval defaults</span>
                    </div>
                </button>
            </h2>
            <div id="collapse-llm" class="accordion-collapse collapse" aria-labelledby="heading-llm"
                data-bs-parent="#settingsAccordion">
                <div class="accordion-body settings-panel-body">
                    {% set provider_current = form_values.llm_name %}
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_name" class="col-md-4 col-form-label">Provider name <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <select id="llm_name" name="llm_name" class="form-control portal-input" required>
                                <option value="" disabled {% if not provider_current %}selected{% endif %}>Select
                                    provider
                                </option>
                                {% for option in provider_options %}
                                <option value="{{ option }}" {% if option==provider_current %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                                {% if provider_current and provider_current not in provider_options %}
                                <option value="{{ provider_current }}" selected>{{ provider_current }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    {% set model_current = form_values.llm_model_answer %}
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_model_answer" class="col-md-4 col-form-label">Model <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <select id="llm_model_answer" name="llm_model_answer" class="form-control portal-input"
                                required>
                                <option value="" disabled {% if not model_current %}selected{% endif %}>Select model
                                </option>
                                {% for option in model_options %}
                                <option value="{{ option }}" {% if option==model_current %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                                {% if model_current and model_current not in model_options %}
                                <option value="{{ model_current }}" selected>{{ model_current }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_api_key" class="col-md-4 col-form-label">API key <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="llm_api_key" name="llm_api_key" value="{{ form_values.llm_api_key }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_top_k" class="col-md-4 col-form-label">Top K</label>
                        <div class="col-md-8">
                            <input id="llm_top_k" name="llm_top_k" value="{{ form_values.llm_top_k }}"
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_temperature" class="col-md-4 col-form-label">Temperature</label>
                        <div class="col-md-8">
                            <input id="llm_temperature" name="llm_temperature" value="{{ form_values.llm_temperature }}"
                                class="form-control portal-input">
                        </div>
                    </div>
                    {% set priority_current = form_values.llm_handoff_priority %}
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_handoff_priority" class="col-md-4 col-form-label">Handoff priority</label>
                        <div class="col-md-8">
                            <select id="llm_handoff_priority" name="llm_handoff_priority"
                                class="form-control portal-input">
                                <option value="" {% if not priority_current %}selected{% endif %}></option>
                                {% for option in handoff_priorities %}
                                <option value="{{ option }}" {% if option==priority_current %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                                {% if priority_current and priority_current not in handoff_priorities %}
                                <option value="{{ priority_current }}" selected>{{ priority_current }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    {% set embed_current = form_values.llm_openai_embed_model %}
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_openai_embed_model" class="col-md-4 col-form-label">Embedding model</label>
                        <div class="col-md-8">
                            <select id="llm_openai_embed_model" name="llm_openai_embed_model"
                                class="form-control portal-input">
                                <option value="" {% if not embed_current %}selected{% endif %}></option>
                                {% for option in embed_options %}
                                <option value="{{ option }}" {% if option==embed_current %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                                {% if embed_current and embed_current not in embed_options %}
                                <option value="{{ embed_current }}" selected>{{ embed_current }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    {% set cross_current = form_values.llm_rag_cross_encoder_model %}
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_rag_cross_encoder_model" class="col-md-4 col-form-label">Cross encoder
                            model</label>
                        <div class="col-md-8">
                            <select id="llm_rag_cross_encoder_model" name="llm_rag_cross_encoder_model"
                                class="form-control portal-input">
                                <option value="" {% if not cross_current %}selected{% endif %}></option>
                                {% for option in cross_encoder_options %}
                                <option value="{{ option }}" {% if option==cross_current %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                                {% if cross_current and cross_current not in cross_encoder_options %}
                                <option value="{{ cross_current }}" selected>{{ cross_current }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="llm_monthly_limit" class="col-md-4 col-form-label">Monthly LLM request limit</label>
                        <div class="col-md-8">
                            <input id="llm_monthly_limit" name="llm_monthly_limit"
                                value="{{ form_values.llm_monthly_limit }}" placeholder="Leave blank for no limit"
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-start">
                        <label for="llm_handoff_public_reply" class="col-md-4 col-form-label">Handoff public
                            reply</label>
                        <div class="col-md-8">
                            <textarea id="llm_handoff_public_reply" name="llm_handoff_public_reply" rows="3"
                                class="form-control portal-input">{{ form_values.llm_handoff_public_reply }}</textarea>
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-start">
                        <label for="llm_handoff_private_note" class="col-md-4 col-form-label">Handoff private
                            note</label>
                        <div class="col-md-8">
                            <textarea id="llm_handoff_private_note" name="llm_handoff_private_note" rows="3"
                                class="form-control portal-input">{{ form_values.llm_handoff_private_note }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-crm">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-crm" aria-expanded="false" aria-controls="collapse-crm">
                    <div>
                        <p class="text-uppercase small fw-semibold text-muted mb-1">CRM bridge</p>
                        <span class="text-muted small">Sync contacts and deals at handoff</span>
                    </div>
                </button>
            </h2>
            <div id="collapse-crm" class="accordion-collapse collapse" aria-labelledby="heading-crm"
                data-bs-parent="#settingsAccordion">
                <div class="accordion-body settings-panel-body">
                    <div class="form-group row mb-3 align-items-center">
                        <label for="crm_url" class="col-md-4 col-form-label">API URL <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="crm_url" name="crm_url" value="{{ form_values.crm_url }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="crm_token" class="col-md-4 col-form-label">API token <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="crm_token" name="crm_token" value="{{ form_values.crm_token }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-omni">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-omni" aria-expanded="false" aria-controls="collapse-omni">
                    <div>
                        <p class="text-uppercase small fw-semibold text-muted mb-1">Omnichannel</p>
                        <span class="text-muted small">Chatwoot credentials</span>
                    </div>
                </button>
            </h2>
            <div id="collapse-omni" class="accordion-collapse collapse" aria-labelledby="heading-omni"
                data-bs-parent="#settingsAccordion">
                <div class="accordion-body settings-panel-body">
                    <div class="form-group row mb-3 align-items-center">
                        <label for="chatwoot_api_url" class="col-md-4 col-form-label">API URL <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="chatwoot_api_url" name="chatwoot_api_url"
                                value="{{ form_values.chatwoot_api_url }}" required class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="chatwoot_account_id" class="col-md-4 col-form-label">Account ID <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="chatwoot_account_id" name="chatwoot_account_id"
                                value="{{ form_values.chatwoot_account_id }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="chatwoot_api_access_token" class="col-md-4 col-form-label">API access token <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="chatwoot_api_access_token" name="chatwoot_api_access_token"
                                value="{{ form_values.chatwoot_api_access_token }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                    <div class="form-group row mb-3 align-items-center">
                        <label for="chatwoot_bot_access_token" class="col-md-4 col-form-label">Bot access token <span
                                class="portal-required">*</span></label>
                        <div class="col-md-8">
                            <input id="chatwoot_bot_access_token" name="chatwoot_bot_access_token"
                                value="{{ form_values.chatwoot_bot_access_token }}" required
                                class="form-control portal-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portal-form-actions portal-form-actions--simple">
        <button type="submit" class="btn btn-primary px-5">Save changes</button>
    </div>
</form>

{% endblock %}
